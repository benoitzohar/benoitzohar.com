# Enabling dark mode

> Empowering my visitor's battery with dark mode.

## Why am I doing this?

I firmly believe that batteries are the main liability of any "modern" device. The company, or person, who will manage to store our energy in a truly efficient way is going to change the way we live.

In the meantime, saving energy can be perceived as a performance enhancement, just not the kind of enhancement you would expect when we talk about performances for the web.

OLED screens can drastically reduce the usage of our battery by not requiring every pixel on the screen to consume the same amount of energy. By making more pixels darker, we will reduce the enery consumption of the screen. 

Although the screen [won't be totally neutral in terms of energy](https://www.oled-info.com/google-details-oled-power-consumption-shows-how-androids-dark-mode-can-help-extend-your-battery-life) if it's entirely black, the darker the better.

## Targetting dark mode devices with css

Saving battery life is good, but we don't want to see websites which are **entirely dark** all the time.
 
To target only dark mode capable devices, and to target them only when they **actually are** in dark mode, we can use the nifty [media query](https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme) `prefers-color-scheme: dark`.
 
By adding a few line of css, we can change the look of our entire page:
 
```css
@media (prefers-color-scheme: dark) {
  body {
    background-color: black;
    color: white;
  }
}
```
 
That css will only be used when the user's device is in dark mode.
 
The [media query](https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme) is already on the latest browser, which means it will probably work well on all dark mode enabled OSes.

[TODO INSERT IMAGE FROM CANIUSE]

## Don't use blend mode

While investigating ways to enable dark mode on my website, I stumbled upon a few articles mentionning the use of the css property `mix-blend-mode` as a *magical* way to turn pages into night-ready gems.

Blend mode allows you to specify how the different layers of your page will blend together. It can be used to create nice effects between text and backgrounds, or images.

`mix-blend-mode: difference;` in particular, tells the browser to display each pixel as the **difference** between the colors of all the pixels "under". 
For example, if a pixel is white (`rgb(255,255,255)`) and you add another white pixel on top of it with `mix-blend-mode: difference;`, the displayed pixel will be `rgb( 255 - 255, 255 - 255, 255 - 255) = rgb(0,0,0)` which is black. If one of those pixels is black instead (`rgb(0,0,0)`), the result will be white (`rgb( 255 - 0, 255 - 0, 255 - 0) = rgb(255,255,255)`).

I think of it as an **inverse** for your components. It applies to **everything** in the page, including text and images.

The process to turn your page into dark mode is to add a white layer on top of the entire page, with `mix-blend-mode: difference;`. It seems straightforward and easy to apply this without having to specify each color. 

However, there are multiple downsides to this approach:

 - A layer on top will prevent your page to behave properly.
 
 This can easily be fixed by putting the blend layer **under** your other components, or at the bottom of the *z* stack if you will.
 
 - Your images, logos and emojis will be reversed.

[TODO insert screenshot from website]

To prevent this from happening, you can **isolate** every element which don't need to be blended. You can use the `isolation` property to achieve this:

```css
 .my-logo, .emoji {
   isolation: isolate; 
 }
```

- Every element with a `z-index` will **not** be blended.

This happens because, [by design](TODO insert link to blend mode stack rule), all elements that create their own stacking context are automatically isolated.

It means that if you specified a `z-index` to any element of the page, it will not be included in the blending process and will be displayed as it originally was. I know that [you shouldn't specify z-index manually](TODO find link to no z-index), but the reality is often different and there are cases where `z-index` comes in handy.
 
TODO: find out if we can cancel isolation for stacked elements

- It's a [heavy process for the renderer](TODO find link to blend mode render perf issues)

To apply a blend mode, your browser renderer needs to calculate the color of each pixel independantly. It means processing millions of pixels on the fly and for every animation that might happen on your page.

---

The code for the changes I'm mentioning in this post is available on Github in [this Pull Request](https://github.com/benoitzohar/benoitzohar.com/pull/4).

## Resources

- https://dev.to/wgao19/night-mode-with-mix-blend-mode-difference-23lm
